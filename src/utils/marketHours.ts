
import { type MarketHours } from '../types/marketTypes';

export class MarketHoursService {
  private marketHoursCache: MarketHours | null = null;

  getMarketHours(): MarketHours {
    if (this.marketHoursCache) {
      return this.marketHoursCache;
    }

    const now = new Date();
    const istTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
    const currentHour = istTime.getHours();
    const currentMinute = istTime.getMinutes();
    const currentDay = istTime.getDay(); // 0 = Sunday, 6 = Saturday

    // Indian markets are open Monday-Friday, 9:15 AM to 3:30 PM IST
    const isWeekday = currentDay >= 1 && currentDay <= 5;
    const isMarketTime = (currentHour === 9 && currentMinute >= 15) || 
                        (currentHour >= 10 && currentHour <= 14) || 
                        (currentHour === 15 && currentMinute <= 30);
    
    const isOpen = isWeekday && isMarketTime;

    // Calculate next open/close times
    let nextOpen = new Date(istTime);
    let nextClose = new Date(istTime);

    if (isOpen) {
      nextClose.setHours(15, 30, 0, 0);
    } else if (isWeekday && currentHour < 9) {
      nextOpen.setHours(9, 15, 0, 0);
      nextClose.setHours(15, 30, 0, 0);
    } else {
      let daysToAdd = 1;
      if (currentDay === 0) daysToAdd = 1; // Sunday -> Monday
      else if (currentDay === 6) daysToAdd = 2; // Saturday -> Monday
      else if (currentHour >= 15 && currentMinute > 30) daysToAdd = 1; // After market close
      
      nextOpen.setDate(nextOpen.getDate() + daysToAdd);
      nextOpen.setHours(9, 15, 0, 0);
      nextClose.setDate(nextClose.getDate() + daysToAdd);
      nextClose.setHours(15, 30, 0, 0);
    }

    this.marketHoursCache = {
      isOpen,
      nextOpen: nextOpen.toLocaleTimeString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        hour: '2-digit',
        minute: '2-digit'
      }),
      nextClose: nextClose.toLocaleTimeString('en-IN', { 
        timeZone: 'Asia/Kolkata',
        hour: '2-digit',
        minute: '2-digit'
      }),
      timezone: 'IST'
    };

    return this.marketHoursCache;
  }

  clearCache() {
    this.marketHoursCache = null;
  }
}
